% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/l3o_variance.R
\name{L3Ovar_iloop_cov}
\alias{L3Ovar_iloop_cov}
\title{Leave-Three-Out Variance Estimator for LM Statistic}
\usage{
L3Ovar_iloop_cov(X, e, P, G, noisy = FALSE)
}
\arguments{
\item{X}{Numeric vector of length n. The endogenous variable.}

\item{e}{Numeric vector of length n. Residuals under the null hypothesis
(\eqn{e = Y - X\beta_0}).}

\item{P}{Matrix of dimension n x n. Projection matrix of the instruments (and potentially covariates).
Corresponds to matrix \eqn{P} or \eqn{H_Q} in the paper.}

\item{G}{Matrix of dimension n x n. Weighting matrix used in the JIVE/UJIVE estimator.
For standard JIVE, G is equal to P. For UJIVE with covariates, G is the adjusted
matrix defined in Section 3.1.}

\item{noisy}{Logical. If \code{TRUE}, print progress dots during the loop.
Defaults to \code{FALSE}.}
}
\value{
Scalar. The estimated variance \eqn{\hat{V}_{LM}}.
}
\description{
Calculates the consistent variance estimator (\eqn{\hat{V}_{LM}}) for the Lagrange Multiplier (LM)
test statistic using the "Leave-Three-Out" (L3O) adjustment.
}
\details{
This variance estimator is robust to both many weak instruments and heterogeneous treatment effects.
It corrects for biases in variance estimation that arise when reduced-form coefficients
are not consistently estimable.

The function computes the variance estimator defined in Equation (9) of Yap (2025):
\deqn{\hat{V}_{LM} = A_1 + A_2 + A_3 + A_4 + A_5}

It iterates through each observation \eqn{i} to compute the necessary adjustments
(Leave-Three-Out determinants \eqn{D_{ijk}}) and aggregates the components using
optimized matrix operations to handle the double sums over \eqn{j} and \eqn{k}.

Specifically:
\itemize{
\item \strong{A1, A2, A3} capture the core variance components involving interactions between
the instruments, endogenous variable, and residuals.
\item \strong{A4, A5} are correction terms that account for the variability from estimating
the reduced-form coefficients (which cannot be treated as fixed in the many-instrument setting).
}

The calculation relies on determinants \eqn{D_{ij}} and \eqn{D_{ijk}} derived from the annihilator
matrix \eqn{M = I - P} to ensure the estimator is unbiased.
}
\references{
Yap, L. (2025). "Inference with Many Weak Instruments and Heterogeneity".
}
